<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Pintar</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 font-poppins">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // Data produk awal tanpa gambar
        const initialProducts = [
  // Kategori: Makanan
  { "id": 1, "name": "Bakso Sapi", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 2, "name": "Kari Lontong Tahu", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 3, "name": "Putu Sokko Beras Ketan", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 4, "name": "Nasi Goreng Spesial", "price": 15000, "category": "Makanan", "stock": 100 },
  { "id": 5, "name": "Nasi Goreng Biasa", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 6, "name": "Nasi Ikan Bakar (Katamba)", "price": 25000, "category": "Makanan", "stock": 100 },
  { "id": 7, "name": "Nasi Ikan Bakar (Bubara)", "price": 25000, "category": "Makanan", "stock": 100 },
  { "id": 8, "name": "Nasi Ikan Bakar (Katombo)", "price": 15000, "category": "Makanan", "stock": 100 },
  { "id": 9, "name": "Nasi Ikan Bakar (Bandeng)", "price": 15000, "category": "Makanan", "stock": 100 },
  { "id": 10, "name": "Ikan Bandeng Presto 1/2 Ekor", "price": 5000, "category": "Makanan", "stock": 100 },
  { "id": 11, "name": "Ikan Bandeng Presto 1 Ekor", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 12, "name": "Gado-Gado (Tanpa Telur)", "price": 12000, "category": "Makanan", "stock": 100 },
  { "id": 13, "name": "Gado-Gado (Pakai Telur)", "price": 15000, "category": "Makanan", "stock": 100 },
  { "id": 14, "name": "Soto Ayam (Tanpa Telur)", "price": 12000, "category": "Makanan", "stock": 100 },
  { "id": 15, "name": "Soto Ayam (Pakai Telur)", "price": 15000, "category": "Makanan", "stock": 100 },
  { "id": 16, "name": "Nasi Lalapan (Ayam)", "price": 20000, "category": "Makanan", "stock": 100 },
  { "id": 17, "name": "Nasi Lalapan (Tahu)", "price": 15000, "category": "Makanan", "stock": 100 },
  { "id": 18, "name": "Nasi Lalapan (Tahu Tempe)", "price": 15000, "category": "Makanan", "stock": 100 },
  { "id": 19, "name": "Nasi Lalapan (Tempe)", "price": 15000, "category": "Makanan", "stock": 100 },
  { "id": 20, "name": "Mi Goreng Spesial", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 21, "name": "Nasi Kuning (Ayam)", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 22, "name": "Nasi Kuning (Ikan)", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 23, "name": "Nasi Kuning (Telur)", "price": 10000, "category": "Makanan", "stock": 100 },
  { "id": 24, "name": "Ambal Ikan", "price": 10000, "category": "Makanan", "stock": 100 },

  // Kategori: Cemilan
  { "id": 25, "name": "Banana Crispy (FLA COKLAT + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 26, "name": "Banana Crispy (FLA COKLAT + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 27, "name": "Banana Crispy (FLA STRAWBERRY + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 28, "name": "Banana Crispy (FLA STRAWBERRY + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 29, "name": "Banana Crispy (FLA TIRAMISU + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 30, "name": "Banana Crispy (FLA TIRAMISU + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 31, "name": "Banana Roll (FLA COKLAT + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 32, "name": "Banana Roll (FLA COKLAT + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 33, "name": "Banana Roll (FLA STRAWBERRY + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 34, "name": "Banana Roll (FLA STRAWBERRY + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 35, "name": "Banana Roll (FLA TIRAMISU + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 36, "name": "Banana Roll (FLA TIRAMISU + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 37, "name": "Cucur", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 38, "name": "Pisang Goreng Kembung (FLA COKLAT + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 39, "name": "Pisang Goreng Kembung (FLA COKLAT + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 40, "name": "Pisang Goreng Kembung (FLA STRAWBERRY + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 41, "name": "Pisang Goreng Kembung (FLA STRAWBERRY + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 42, "name": "Pisang Goreng Kembung (FLA TIRAMISU + TOPING SERUTAN COKLAT)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 43, "name": "Pisang Goreng Kembung (FLA TIRAMISU + TOPING SERUTAN KEJU)", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 44, "name": "Onde-Onde Jawa", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 45, "name": "Surabeng", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 46, "name": "Wingko G4", "price": 10000, "category": "Cemilan", "stock": 100 },
  { "id": 47, "name": "Tetu Nipa", "price": 10000, "category": "Cemilan", "stock": 100 },

  // Kategori: Minuman
  { "id": 48, "name": "Minuman Aneka Rempah Nusantara", "price": 3000, "category": "Minuman", "stock": 100 },
  { "id": 49, "name": "Minuman Aneka Rempah Madu + Susu Kambing Etawa", "price": 15000, "category": "Minuman", "stock": 100 },
  { "id": 50, "name": "Jus Lidah Buaya", "price": 10000, "category": "Minuman", "stock": 100 },
  { "id": 51, "name": "Jus Buah Naga", "price": 10000, "category": "Minuman", "stock": 100 },
  { "id": 52, "name": "Jus Jeruk", "price": 10000, "category": "Minuman", "stock": 100 },
  { "id": 53, "name": "Jus Alpukat", "price": 10000, "category": "Minuman", "stock": 100 },
  { "id": 54, "name": "Ice Stiky Milk Coklat", "price": 5000, "category": "Minuman", "stock": 100 },
  { "id": 55, "name": "Ice Stiky Milk Cappucino", "price": 5000, "category": "Minuman", "stock": 100 },
  { "id": 56, "name": "Ice Stiky Milk Melon", "price": 5000, "category": "Minuman", "stock": 100 },
  { "id": 57, "name": "Ice Stiky Milk Avocado", "price": 5000, "category": "Minuman", "stock": 100 },
  { "id": 58, "name": "Kopi O'", "price": 5000, "category": "Minuman", "stock": 100 },
  { "id": 59, "name": "Kopi Jahe", "price": 5000, "category": "Minuman", "stock": 100 },
  { "id": 60, "name": "Kopi Susu", "price": 5000, "category": "Minuman", "stock": 100 },
  { "id": 61, "name": "Teh O'", "price": 5000, "category": "Minuman", "stock": 100 },
  { "id": 62, "name": "Sarabba", "price": 5000, "category": "Minuman", "stock": 100 }
        ];

        // Komponen Splash Screen
        const SplashScreen = ({ onComplete }) => {
            useEffect(() => {
                const timer = setTimeout(onComplete, 2000);
                return () => clearTimeout(timer);
            }, [onComplete]);

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <img src="LOGO.png" alt="Logo Kasir Pintar" className="w-50 sm:w-50" />
                </div>
            );
        };

        // Komponen Login
        const Login = ({ setUser }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = () => {
                if (username === 'admin' && password === 'putricantik*') {
                    setUser({ role: 'admin', userId: 'Putri' });
                } else if (username === 'kasir1' && password === 'lianigurl') {
                    setUser({ role: 'kasir', userId: 'April' });
                } else if (username === 'kasir2' && password === 'kasirunit2') {
                    setUser({ role: 'kasir', userId: 'Agung' });
                } else if (username === 'kasir3' && password === 'kasirunitkefin') {
                    setUser({ role: 'kasir', userId: 'Kefin' });
                } else {
                    setError('Username atau password salah');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center px-4">
                    <div className="bg-white p-6 rounded-md shadow-lg w-full max-w-sm">
                        <img src="LOGO.png" alt="Logo Kasir Pintar" className="w-24 sm:w-32 mx-auto mb-6" />
                        <h2 className="text-xl sm:text-2xl font-semibold mb-6 text-center text-gray-800 font-poppins">Login</h2>
                        <input
                            type="text"
                            placeholder="Username"
                            value={username}
                            onChange={(e) => setUsername(e.target.value)}
                            className="w-full p-2 mb-4 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins"
                        />
                        <input
                            type="password"
                            placeholder="Password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full p-2 mb-4 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins"
                        />
                        {error && <p className="text-red-500 mb-4 text-sm font-poppins">{error}</p>}
                        <button
                            onClick={handleLogin}
                            className="w-full bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 font-poppins"
                        >
                            Login
                        </button>
                    </div>
                </div>
            );
        };

        // Komponen Manajemen Produk
        const ProductManagement = ({ products, setProducts, categories, setCategories }) => {
            const [name, setName] = useState('');
            const [price, setPrice] = useState('');
            const [category, setCategory] = useState('');
            const [stock, setStock] = useState('');
            const [newCategory, setNewCategory] = useState('');
            const [editId, setEditId] = useState(null);

            const addProduct = () => {
                if (name && price && category && stock) {
                    const updatedProducts = editId
                        ? products.map(p => (p.id === editId ? { id: editId, name, price: parseFloat(price), category, stock: parseInt(stock) } : p))
                        : [...products, { id: Date.now(), name, price: parseFloat(price), category, stock: parseInt(stock) }];
                    setProducts(updatedProducts);
                    localStorage.setItem('products', JSON.stringify(updatedProducts));
                    setName(''); setPrice(''); setCategory(''); setStock(''); setEditId(null);
                }
            };

            const addCategory = () => {
                if (newCategory && !categories.includes(newCategory)) {
                    const updatedCategories = [...categories, newCategory];
                    setCategories(updatedCategories);
                    localStorage.setItem('categories', JSON.stringify(updatedCategories));
                    setNewCategory('');
                }
            };

            const editProduct = (product) => {
                setName(product.name); setPrice(product.price); setCategory(product.category); setStock(product.stock); setEditId(product.id);
            };

            const deleteProduct = (id) => {
                const updatedProducts = products.filter(p => p.id !== id);
                setProducts(updatedProducts);
                localStorage.setItem('products', JSON.stringify(updatedProducts));
            };

            return (
                <div className="p-4 sm:p-6">
                    <h2 className="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 font-poppins">Manajemen Produk</h2>
                    <div className="mb-4 flex flex-col sm:flex-row gap-2">
                        <input type="text" placeholder="Nama Produk" value={name} onChange={(e) => setName(e.target.value)} className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins" />
                        <input type="number" placeholder="Harga" value={price} onChange={(e) => setPrice(e.target.value)} className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins" />
                        <input type="number" placeholder="Stok" value={stock} onChange={(e) => setStock(e.target.value)} className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins" />
                        <select value={category} onChange={(e) => setCategory(e.target.value)} className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins">
                            <option value="" className="font-poppins">Pilih Kategori</option>
                            {categories.map(cat => <option key={cat} value={cat} className="font-poppins">{cat}</option>)}
                        </select>
                        <button onClick={addProduct} className="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors duration-200 font-poppins">{editId ? 'Update' : 'Tambah'}</button>
                    </div>
                    <div className="mb-4 flex gap-2">
                        <input type="text" placeholder="Kategori Baru" value={newCategory} onChange={(e) => setNewCategory(e.target.value)} className="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins" />
                        <button onClick={addCategory} className="bg-green-500 text-white p-2 rounded-full hover:bg-green-600 transition-colors duration-200 font-poppins">Tambah Kategori</button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full border-collapse">
                            <thead><tr className="bg-gray-200"><th className="border p-2 text-left text-gray-800 font-poppins">Nama</th><th className="border p-2 text-left text-gray-800 font-poppins">Harga</th><th className="border p-2 text-left text-gray-800 font-poppins">Stok</th><th className="border p-2 text-left text-gray-800 font-poppins">Kategori</th><th className="border p-2 text-left text-gray-800 font-poppins">Aksi</th></tr></thead>
                            <tbody>{products.map(product => (
                                <tr key={product.id} className="border">
                                    <td className="border p-2 text-gray-800 font-poppins">{product.name}</td>
                                    <td className="border p-2 text-gray-800 font-poppins">Rp {product.price.toLocaleString()}</td>
                                    <td className="border p-2 text-gray-800 font-poppins">{product.stock}</td>
                                    <td className="border p-2 text-gray-800 font-poppins">{product.category}</td>
                                    <td className="border p-2"><button onClick={() => editProduct(product)} className="bg-yellow-500 text-white p-1 rounded-full mr-2 hover:bg-yellow-600 transition-colors duration-200 font-poppins">Edit</button><button onClick={() => deleteProduct(product.id)} className="bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors duration-200 font-poppins">Hapus</button></td>
                                </tr>
                            ))}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Komponen Transaksi Penjualan
        const SalesTransaction = ({ products, transactions, setTransactions, setProducts, user }) => {
            const [cart, setCart] = useState([]);
            const [search, setSearch] = useState('');
            const [paymentAmount, setPaymentAmount] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('cash');
            const [errorMessage, setErrorMessage] = useState('');
            const [discountPercent, setDiscountPercent] = useState('');
            const [shippingCost, setShippingCost] = useState('');

            const addToCart = (product) => {
                if (product.stock > 0) {
                    const existing = cart.find(item => item.id === product.id);
                    if (existing) {
                        if (existing.quantity < product.stock) setCart(cart.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item));
                    } else setCart([...cart, { ...product, quantity: 1 }]);
                }
            };

            const removeFromCart = (id) => setCart(cart.filter(item => item.id !== id));

            const updateQuantity = (id, quantity) => {
                const item = cart.find(item => item.id === id);
                if (item && quantity <= item.stock) setCart(cart.map(item => item.id === id ? { ...item, quantity: parseInt(quantity) } : item));
            };

            const calculateTotal = () => {
                const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const discountPercentValue = parseFloat(discountPercent) || 0;
                const discountAmount = (discountPercentValue / 100) * subtotal;
                const shipping = parseFloat(shippingCost) || 0;
                return Math.max(0, subtotal - discountAmount + shipping);
            };

            const calculateDiscountAmount = () => {
                const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const discountPercentValue = parseFloat(discountPercent) || 0;
                return (discountPercentValue / 100) * subtotal;
            };

            const completeTransaction = () => {
                if (cart.length === 0) {
                    setErrorMessage('Keranjang kosong!');
                    return;
                }

                const total = calculateTotal();
                const amount = parseFloat(paymentAmount) || 0;

                if (isNaN(amount) || amount < total) {
                    setErrorMessage('Nominal bayar kurang atau tidak valid!');
                    return;
                }

                const updatedProducts = products.map(p => {
                    const cartItem = cart.find(item => item.id === p.id);
                    return cartItem ? { ...p, stock: p.stock - cartItem.quantity } : p;
                });
                setProducts(updatedProducts);

                const transactionItems = cart.map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity, category: item.category }));
                const discountPercentValue = parseFloat(discountPercent) || 0;
                const discountAmount = calculateDiscountAmount();
                const shipping = parseFloat(shippingCost) || 0;
                const change = amount - total;
                const newTransaction = { 
                    id: Date.now(), 
                    items: transactionItems, 
                    total, 
                    discountPercent: discountPercentValue,
                    discountAmount: discountAmount,
                    shippingCost: shipping,
                    date: new Date(), 
                    paymentMethod, 
                    paymentAmount: amount, 
                    change,
                    userId: user.userId
                };
                let updatedTransactions = [...transactions, newTransaction];

                const MAX_STORAGE_SIZE = 4500000;
                let transactionsStr = JSON.stringify(updatedTransactions);
                if (transactionsStr.length > MAX_STORAGE_SIZE) {
                    console.log('Penyimpanan mendekati penuh, menghapus transaksi lama...');
                    updatedTransactions = updatedTransactions.slice(-50);
                    setErrorMessage('Penyimpanan penuh, transaksi lama dihapus otomatis.');
                    transactionsStr = JSON.stringify(updatedTransactions);
                }

                try {
                    localStorage.setItem('products', JSON.stringify(updatedProducts));
                    localStorage.setItem('transactions', transactionsStr);
                    setTransactions(updatedTransactions);
                    console.log('Transaksi berhasil disimpan:', newTransaction);
                } catch (e) {
                    console.error('LocalStorage error:', e);
                    setErrorMessage('Gagal simpan transaksi, coba hapus riwayat manual di tab Riwayat Transaksi.');
                    return;
                }

                const pdfUrl = generatePDF(newTransaction.id, cart, total, discountPercentValue, discountAmount, shipping, paymentMethod, amount, change, user.userId);
                if (pdfUrl) {
                    try {
                        console.log('Mencoba buka struk...');
                        const newWindow = window.open(pdfUrl, '_blank');
                        if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                            setErrorMessage('Popup diblokir, unduh struk di file struk_pembelian.pdf.');
                        } else {
                            setErrorMessage('Transaksi berhasil, cek struk di jendela baru!');
                        }
                    } catch (e) {
                        console.error('Error membuka popup:', e);
                        setErrorMessage('Gagal buka preview, unduh struk di file struk_pembelian.pdf.');
                    }
                } else {
                    console.log('Gagal menghasilkan PDF, cek fallback.');
                    setErrorMessage('Gagal menghasilkan struk, cek file lokal struk_pembelian.pdf.');
                }

                setCart([]);
                setPaymentAmount('');
                setDiscountPercent('');
                setShippingCost('');
                setTimeout(() => setErrorMessage(''), 5000);
            };

            const generatePDF = (transactionId, items, total, discountPercent, discountAmount, shippingCost, paymentMethod, paymentAmount, change, userId) => {
                if (typeof window.jspdf === 'undefined') {
                    console.error('jsPDF tidak dimuat!');
                    setErrorMessage('Gagal memuat library PDF, cek koneksi internet.');
                    return null;
                }

                try {
                    console.log('Memulai pembuatan PDF...');
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: [80, 297]
                    });

                    doc.setFont("Courier", "normal");
                    doc.setFontSize(12);

                    doc.text('UNIT USAHA TERPADU', 40, 10, { align: 'center' });
                    doc.text('RUMAH TANGGA KULINER', 40, 15, { align: 'center' });
                    doc.text('MERDEKA NIBANGUN RAYA', 40, 20, { align: 'center' });
                    doc.setFontSize(8);
                    doc.text('Desa Ginunggung, Kec. Galang', 40, 26, { align: 'center' });
                    doc.text('Kab. Tolitoli, Prov. Sulawesi Tengah', 40, 31, { align: 'center' });
                    doc.text('Kode Pos 94561', 40, 36, { align: 'center' });
                    doc.text('Admin: 0822-7162-4019 (Putri)', 40, 41, { align: 'center' });
                    doc.setLineWidth(0.3);
                    doc.line(5, 45, 75, 45);

                    doc.setFontSize(10);
                    doc.text(`No. Struk: ${transactionId}`, 5, 51);
                    doc.text(`Tanggal: ${new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })}`, 5, 56);
                    doc.text(`Metode: ${paymentMethod === 'qris' ? 'QRIS' : 'Tunai'}`, 5, 61);
                    doc.text(`Kasir: ${userId}`, 5, 66);
                    doc.line(5, 70, 75, 70);

                    doc.autoTable({
                        startY: 73,
                        head: [['No', 'Produk', 'Jml', 'Harga', 'Total']],
                        body: items.map((item, index) => [
                            index + 1,
                            item.name, // Display full product name without truncation
                            item.quantity,
                            `${item.price.toLocaleString()}`,
                            `${(item.price * item.quantity).toLocaleString()}`
                        ]),
                        styles: { 
                            font: 'Courier', 
                            fontSize: 8, 
                            cellPadding: 1, 
                            overflow: 'linebreak' 
                        },
                        headStyles: { 
                            fillColor: [200, 200, 200], 
                            textColor: [0, 0, 0], 
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        columnStyles: {
                            0: { cellWidth: 8, halign: 'center' },
                            1: { cellWidth: 30, overflow: 'linebreak' },
                            2: { cellWidth: 8, halign: 'center' },
                            3: { cellWidth: 12, halign: 'right' },
                            4: { cellWidth: 12, halign: 'right' }
                        },
                        margin: { left: 5, right: 5 },
                        tableWidth: 70
                    });

                    const finalY = doc.lastAutoTable.finalY + 3;
                    doc.line(5, finalY, 75, finalY);
                    doc.setFontSize(9);
                    doc.text(`Subtotal: Rp ${cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toLocaleString()}`, 55, finalY + 5, { align: 'right' });
                    doc.text(`Diskon (${discountPercent}%): Rp ${discountAmount.toLocaleString()}`, 55, finalY + 10, { align: 'right' });
                    doc.text(`Ongkir: Rp ${shippingCost.toLocaleString()}`, 55, finalY + 15, { align: 'right' });
                    doc.text(`Total: Rp ${total.toLocaleString()}`, 55, finalY + 20, { align: 'right' });
                    doc.text(`Bayar: Rp ${paymentAmount.toLocaleString()}`, 55, finalY + 25, { align: 'right' });
                    doc.text(`Kembali: Rp ${change.toLocaleString() || '0'}`, 55, finalY + 30, { align: 'right' });
                    doc.line(5, finalY + 33, 75, finalY + 33);

                    doc.setFontSize(8);
                    doc.setFont("Courier", "italic");
                    doc.text('Terima Kasih', 40, finalY + 39, { align: 'center' });
                    doc.text('Kasir Pintar by Putri', 40, finalY + 43, { align: 'center' });

                    const pdfDataUri = doc.output('datauristring');
                    doc.save(`struk_pembelian_${transactionId}.pdf`);
                    console.log('PDF berhasil dibuat:', pdfDataUri);
                    return pdfDataUri;
                } catch (error) {
                    console.error('Error dalam generate PDF:', error);
                    setErrorMessage('Gagal menghasilkan struk, file disimpan lokal sebagai struk_pembelian.pdf.');
                    doc.save('struk_pembelian.pdf');
                    return null;
                }
            };

            const filteredProducts = products.filter(p => p.name.toLowerCase().includes(search.toLowerCase()));
            const total = calculateTotal();
            const discountAmount = calculateDiscountAmount();

            return (
                <div className="p-4 sm:p-6">
                    <h2 className="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 font-poppins">Transaksi Penjualan</h2>
                    <input
                        type="text"
                        placeholder="Cari Produk..."
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        className="w-full p-2 mb-4 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins"
                    />
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <h3 className="text-lg font-medium mb-2 text-gray-800 font-poppins">Produk</h3>
                            <div className="max-h-96 overflow-y-auto">
                                {filteredProducts.map(product => (
                                    <div key={product.id} className="border p-2 mb-2 rounded flex justify-between items-center">
                                        <div>
                                            <p className="text-gray-800 font-poppins">{product.name}</p>
                                            <p className="text-gray-800 font-poppins">Rp {product.price.toLocaleString()}</p>
                                            <p className="text-gray-600 text-sm font-poppins">Stok: {product.stock}</p>
                                        </div>
                                        <button onClick={() => addToCart(product)} className="bg-blue-500 text-white p-1 rounded-full hover:bg-blue-600 transition-colors duration-200 font-poppins" disabled={product.stock === 0}>Tambah</button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div>
                            <h3 className="text-lg font-medium mb-2 text-gray-800 font-poppins">Keranjang</h3>
                            {cart.map(item => (
                                <div key={item.id} className="border p-2 mb-2 rounded flex justify-between items-center">
                                    <div>
                                        <p className="text-gray-800 font-poppins">{item.name}</p>
                                        <p className="text-gray-800 font-poppins">Rp {(item.price * item.quantity).toLocaleString()}</p>
                                        <input
                                            type="number"
                                            value={item.quantity}
                                            onChange={(e) => updateQuantity(item.id, e.target.value)}
                                            className="w-16 p-1 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins"
                                            min="1"
                                            max={item.stock}
                                        />
                                    </div>
                                    <button onClick={() => removeFromCart(item.id)} className="bg-red-500 text-white p-1 rounded-full hover:bg-red-600 transition-colors duration-200 font-poppins">Hapus</button>
                                </div>
                            ))}
                            <p className="font-semibold text-gray-800 font-poppins">Subtotal: Rp {cart.reduce((sum, item) => sum + item.price * item.quantity, 0).toLocaleString()}</p>
                            <p className="font-semibold text-gray-800 font-poppins">Diskon ({discountPercent}%): Rp {discountAmount.toLocaleString()}</p>
                            <p className="font-semibold text-gray-800 font-poppins">Ongkir: Rp {(parseFloat(shippingCost) || 0).toLocaleString()}</p>
                            <p className="font-semibold text-gray-800 font-poppins">Total: Rp {total.toLocaleString()}</p>
                            <div className="mb-4">
                                <label className="block text-gray-700 font-poppins">Metode Pembayaran:</label>
                                <div className="flex gap-4 mb-2">
                                    <label className="flex items-center font-poppins"><input type="radio" value="cash" checked={paymentMethod === 'cash'} onChange={(e) => setPaymentMethod(e.target.value)} className="mr-2" />Tunai</label>
                                    <label className="flex items-center font-poppins"><input type="radio" value="qris" checked={paymentMethod === 'qris'} onChange={(e) => setPaymentMethod(e.target.value)} className="mr-2" />QRIS</label>
                                </div>
                                <input
                                    type="number"
                                    placeholder="Diskon (%)"
                                    value={discountPercent}
                                    onChange={(e) => setDiscountPercent(e.target.value)}
                                    className="w-full p-2 mb-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins"
                                    min="0"
                                    max="100"
                                />
                                <input
                                    type="number"
                                    placeholder="Biaya Ongkir (Rp)"
                                    value={shippingCost}
                                    onChange={(e) => setShippingCost(e.target.value)}
                                    className="w-full p-2 mb-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins"
                                    min="0"
                                />
                                <input
                                    type="number"
                                    placeholder="Nominal Bayar"
                                    value={paymentAmount}
                                    onChange={(e) => setPaymentAmount(e.target.value)}
                                    className="w-full p-2 mb-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins"
                                    min="0"
                                />
                                {paymentAmount && <p className="text-green-600 font-poppins">Kembali: Rp {((parseFloat(paymentAmount) || 0) - total).toLocaleString()}</p>}
                                {errorMessage && <p className={`text-sm font-poppins ${errorMessage.includes('berhasil') ? 'text-green-500' : 'text-red-500'}`}>{errorMessage}</p>}
                            </div>
                            <button onClick={completeTransaction} className="bg-green-500 text-white p-2 rounded-full mt-4 w-full hover:bg-green-600 transition-colors duration-200 font-poppins">
                                Selesaikan Transaksi
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Riwayat Transaksi
        const TransactionHistory = ({ transactions, setTransactions, user }) => {
            const [activeUserTab, setActiveUserTab] = useState('all');

            const clearTransactions = (userId) => {
                if (window.confirm(`Apakah Anda yakin ingin menghapus semua riwayat transaksi untuk ${userId === 'all' ? 'semua pengguna' : userId}?`)) {
                    if (userId === 'all') {
                        setTransactions([]);
                        localStorage.setItem('transactions', JSON.stringify([]));
                    } else {
                        const updatedTransactions = transactions.filter(t => t.userId !== userId);
                        setTransactions(updatedTransactions);
                        localStorage.setItem('transactions', JSON.stringify(updatedTransactions));
                    }
                    console.log(`Riwayat transaksi untuk ${userId} dihapus.`);
                }
            };

            const filteredTransactions = user.role === 'admin' && activeUserTab !== 'all'
                ? transactions.filter(t => t.userId === activeUserTab)
                : transactions;

            return (
                <div className="p-4 sm:p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl sm:text-2xl font-semibold text-gray-800 font-poppins">Riwayat Transaksi</h2>
                        {user.role === 'admin' && (
                            <button onClick={() => clearTransactions(activeUserTab)} className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-200 font-poppins">
                                Hapus Riwayat {activeUserTab === 'all' ? 'Semua' : activeUserTab}
                            </button>
                        )}
                    </div>
                    {user.role === 'admin' && (
                        <div className="mb-4 flex gap-2">
                            <button
                                onClick={() => setActiveUserTab('all')}
                                className={`p-2 rounded ${activeUserTab === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400'} font-poppins`}
                            >
                                Semua
                            </button>
                            <button
                                onClick={() => setActiveUserTab('kasir1')}
                                className={`p-2 rounded ${activeUserTab === 'kasir1' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400'} font-poppins`}
                            >
                                Kasir 1
                            </button>
                            <button
                                onClick={() => setActiveUserTab('kasir2')}
                                className={`p-2 rounded ${activeUserTab === 'kasir2' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400'} font-poppins`}
                            >
                                Kasir 2
                            </button>
                            <button
                                onClick={() => setActiveUserTab('admin')}
                                className={`p-2 rounded ${activeUserTab === 'admin' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400'} font-poppins`}
                            >
                                Admin
                            </button>
                        </div>
                    )}
                    <div className="overflow-x-auto">
                        <table className="w-full border-collapse">
                            <thead>
                                <tr className="bg-gray-200">
                                    <th className="border p-2 text-left text-gray-800 font-poppins">ID</th>
                                    <th className="border p-2 text-left text-gray-800 font-poppins">Tanggal</th>
                                    {user.role === 'admin' && <th className="border p-2 text-left text-gray-800 font-poppins">Kasir</th>}
                                    <th className="border p-2 text-left text-gray-800 font-poppins">Total</th>
                                    <th className="border p-2 text-left text-gray-800 font-poppins">Diskon</th>
                                    <th className="border p-2 text-left text-gray-800 font-poppins">Ongkir</th>
                                    <th className="border p-2 text-left text-gray-800 font-poppins">Metode</th>
                                    <th className="border p-2 text-left text-gray-800 font-poppins">Bayar</th>
                                    <th className="border p-2 text-left text-gray-800 font-poppins">Kembali</th>
                                    <th className="border p-2 text-left text-gray-800 font-poppins">Detail</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredTransactions.map(t => (
                                    <tr key={t.id} className="border">
                                        <td className="border p-2 text-gray-800 font-poppins">{t.id}</td>
                                        <td className="border p-2 text-gray-800 font-poppins">{t.date.toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })}</td>
                                        {user.role === 'admin' && <td className="border p-2 text-gray-800 font-poppins">{t.userId}</td>}
                                        <td className="border p-2 text-gray-800 font-poppins">Rp {t.total.toLocaleString()}</td>
                                        <td className="border p-2 text-gray-800 font-poppins">{t.discountPercent}% (Rp {t.discountAmount.toLocaleString()})</td>
                                        <td className="border p-2 text-gray-800 font-poppins">Rp {(t.shippingCost || 0).toLocaleString()}</td>
                                        <td className="border p-2 text-gray-800 font-poppins">{t.paymentMethod === 'qris' ? 'QRIS' : 'Tunai'}</td>
                                        <td className="border p-2 text-gray-800 font-poppins">Rp {t.paymentAmount.toLocaleString()}</td>
                                        <td className="border p-2 text-gray-800 font-poppins">Rp {t.change.toLocaleString()}</td>
                                        <td className="border p-2 text-gray-800 font-poppins">
                                            <ul className="list-disc pl-4">
                                                {t.items.map(item => (
                                                    <li key={item.id} className="font-poppins">{item.name} x{item.quantity}</li>
                                                ))}
                                            </ul>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // Komponen Dashboard Statistik
        const Dashboard = ({ transactions, user }) => {
            const calculateRevenue = (trans, period) => {
                const revenueByUser = { admin: {}, kasir1: {}, kasir2: {} };
                trans.forEach(t => {
                    const key = period === 'daily'
                        ? t.date.toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' })
                        : t.date.toLocaleString('id-ID', { month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' });
                    revenueByUser[t.userId] = revenueByUser[t.userId] || {};
                    revenueByUser[t.userId][key] = (revenueByUser[t.userId][key] || 0) + t.total;
                });
                return revenueByUser;
            };

            const dailyRevenue = calculateRevenue(transactions, 'daily');
            const monthlyRevenue = calculateRevenue(transactions, 'monthly');

            return (
                <div className="p-4 sm:p-6">
                    <h2 className="text-xl sm:text-2xl font-semibold mb-4 text-gray-800 font-poppins">Dashboard Statistik</h2>
                    {user.role === 'admin' ? (
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <h3 className="text-lg font-medium mb-2 text-gray-800 font-poppins">Pendapatan Harian</h3>
                                <h4 className="text-md font-medium mb-1 text-gray-700 font-poppins">Admin</h4>
                                {Object.entries(dailyRevenue.admin || {}).map(([date, total]) => (
                                    <p key={date} className="text-gray-800 font-poppins">{date}: Rp {total.toLocaleString()}</p>
                                ))}
                                <h4 className="text-md font-medium mb-1 mt-4 text-gray-700 font-poppins">Kasir 1</h4>
                                {Object.entries(dailyRevenue.kasir1 || {}).map(([date, total]) => (
                                    <p key={date} className="text-gray-800 font-poppins">{date}: Rp {total.toLocaleString()}</p>
                                ))}
                                <h4 className="text-md font-medium mb-1 mt-4 text-gray-700 font-poppins">Kasir Lainnya</h4>
                                {Object.entries(dailyRevenue.kasir2 || {}).map(([date, total]) => (
                                    <p key={date} className="text-gray-800 font-poppins">{date}: Rp {total.toLocaleString()}</p>
                                ))}
                            </div>
                            <div>
                                <h3 className="text-lg font-medium mb-2 text-gray-800 font-poppins">Pendapatan Bulanan</h3>
                                <h4 className="text-md font-medium mb-1 text-gray-700 font-poppins">Admin</h4>
                                {Object.entries(monthlyRevenue.admin || {}).map(([month, total]) => (
                                    <p key={month} className="text-gray-800 font-poppins">{month}: Rp {total.toLocaleString()}</p>
                                ))}
                                <h4 className="text-md font-medium mb-1 mt-4 text-gray-700 font-poppins">Kasir 1</h4>
                                {Object.entries(monthlyRevenue.kasir1 || {}).map(([month, total]) => (
                                    <p key={month} className="text-gray-800 font-poppins">{month}: Rp {total.toLocaleString()}</p>
                                ))}
                                <h4 className="text-md font-medium mb-1 mt-4 text-gray-700 font-poppins">Kasir Lainnya</h4>
                                {Object.entries(monthlyRevenue.kasir2 || {}).map(([month, total]) => (
                                    <p key={month} className="text-gray-800 font-poppins">{month}: Rp {total.toLocaleString()}</p>
                                ))}
                            </div>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <h3 className="text-lg font-medium mb-2 text-gray-800 font-poppins">Pendapatan Harian</h3>
                                {Object.entries(dailyRevenue[user.userId] || {}).map(([date, total]) => (
                                    <p key={date} className="text-gray-800 font-poppins">{date}: Rp {total.toLocaleString()}</p>
                                ))}
                            </div>
                            <div>
                                <h3 className="text-lg font-medium mb-2 text-gray-800 font-poppins">Pendapatan Bulanan</h3>
                                {Object.entries(monthlyRevenue[user.userId] || {}).map(([month, total]) => (
                                    <p key={month} className="text-gray-800 font-poppins">{month}: Rp {total.toLocaleString()}</p>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Komponen Utama
        const App = () => {
            const [user, setUser] = useState(null);
            const [showSplash, setShowSplash] = useState(true);
            const [products, setProducts] = useState(() => {
                const storedProducts = JSON.parse(localStorage.getItem('products') || '[]');
                if (storedProducts.length === 0) {
                    localStorage.setItem('products', JSON.stringify(initialProducts));
                    return initialProducts;
                }
                return storedProducts;
            });
            const [transactions, setTransactions] = useState(() => JSON.parse(localStorage.getItem('transactions') || '[]').map(t => ({ ...t, date: new Date(t.date) })));
            const [categories, setCategories] = useState(() => {
                const storedCategories = JSON.parse(localStorage.getItem('categories') || '[]');
                if (storedCategories.length === 0) {
                    const initialCategories = ['Makanan', 'Minuman', 'Cemilan'];
                    localStorage.setItem('categories', JSON.stringify(initialCategories));
                    return initialCategories;
                }
                return storedCategories;
            });
            const [activeTab, setActiveTab] = useState('dashboard');

            if (showSplash) return <SplashScreen onComplete={() => setShowSplash(false)} />;
            if (!user) return <Login setUser={setUser} />;

            return (
                <div className="min-h-screen flex flex-col font-poppins">
                    <nav className="bg-blue-600 text-white p-4 flex flex-col sm:flex-row justify-between items-center">
                        <div className="flex items-center mb-2 sm:mb-0">
                            <img src="LOGO.png" alt="Logo Kasir Pintar" className="w-10 sm:w-12 mr-2" />
                            <h1 className="text-lg sm:text-xl font-semibold font-poppins">Kasir Pintar</h1>
                        </div>
                        <div>
                            <span className="mr-4 font-poppins">Selamat datang, {user.userId}</span>
                            <button onClick={() => setUser(null)} className="bg-red-500 text-white p-2 rounded-full hover:bg-red-600 transition-colors duration-200 font-poppins">Logout</button>
                        </div>
                    </nav>
                    <div className="flex flex-col sm:flex-row flex-1">
                        <div className="w-full sm:w-64 bg-gray-200 p-4">
                            <button onClick={() => setActiveTab('dashboard')} className={`w-full p-2 mb-2 rounded text-gray-800 ${activeTab === 'dashboard' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400 transition-colors duration-200'} font-poppins`}>Dashboard</button>
                            <button onClick={() => setActiveTab('transaction')} className={`w-full p-2 mb-2 rounded text-gray-800 ${activeTab === 'transaction' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400 transition-colors duration-200'} font-poppins`}>Transaksi</button>
                            {user.role === 'admin' && <button onClick={() => setActiveTab('products')} className={`w-full p-2 mb-2 rounded text-gray-800 ${activeTab === 'products' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400 transition-colors duration-200'} font-poppins`}>Manajemen Produk</button>}
                            <button onClick={() => setActiveTab('history')} className={`w-full p-2 mb-2 rounded text-gray-800 ${activeTab === 'history' ? 'bg-blue-500 text-white' : 'bg-gray-300 hover:bg-gray-400 transition-colors duration-200'} font-poppins`}>Riwayat Transaksi</button>
                        </div>
                        <div className="flex-1 p-4 sm:p-6 overflow-x-auto">
                            {activeTab === 'dashboard' && <Dashboard transactions={transactions} user={user} />}
                            {activeTab === 'transaction' && <SalesTransaction products={products} transactions={transactions} setTransactions={setTransactions} setProducts={setProducts} user={user} />}
                            {activeTab === 'products' && user.role === 'admin' && <ProductManagement products={products} setProducts={setProducts} categories={categories} setCategories={setCategories} />}
                            {activeTab === 'history' && <TransactionHistory transactions={transactions} setTransactions={setTransactions} user={user} />}
                        </div>
                    </div>
                    <footer className="bg-gray-800 text-white text-center p-2 text-sm font-poppins">© 2025 Kasir Pintar by Putri</footer>
                </div>
            );
        };

        // Render dengan createRoot
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>